# OmniVibe Pro - Makefile

.PHONY: help install up down logs test test-api clean

# ê¸°ë³¸ê°’ - ìë™ ê°ì§€
DOCKER_COMPOSE = $(shell docker compose version >/dev/null 2>&1 && echo "docker compose" || echo "docker-compose")
PYTHON = python3
POETRY = poetry

help: ## ë„ì›€ë§ í‘œì‹œ
	@echo "OmniVibe Pro - Make Commands"
	@echo "============================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## Poetry ì˜ì¡´ì„± ì„¤ì¹˜
	@echo "ğŸ“¦ Installing dependencies..."
	$(POETRY) install

up: ## Docker Compose ì„œë¹„ìŠ¤ ì‹œì‘
	@echo "ğŸš€ Starting all services..."
	$(DOCKER_COMPOSE) up -d
	@echo "âœ“ Services started!"
	@echo ""
	@echo "Services running at:"
	@echo "  - FastAPI:  http://localhost:8000"
	@echo "  - API Docs: http://localhost:8000/docs"
	@echo "  - Flower:   http://localhost:5555"
	@echo "  - Neo4j:    http://localhost:7474"
	@echo ""
	@$(MAKE) status

down: ## Docker Compose ì„œë¹„ìŠ¤ ì¤‘ì§€
	@echo "ğŸ›‘ Stopping all services..."
	$(DOCKER_COMPOSE) down

restart: ## ì„œë¹„ìŠ¤ ì¬ì‹œì‘
	@$(MAKE) down
	@$(MAKE) up

logs: ## ë¡œê·¸ í™•ì¸ (ì‹¤ì‹œê°„)
	$(DOCKER_COMPOSE) logs -f

logs-api: ## FastAPI ë¡œê·¸ë§Œ í™•ì¸
	$(DOCKER_COMPOSE) logs -f api

logs-celery: ## Celery Worker ë¡œê·¸ë§Œ í™•ì¸
	$(DOCKER_COMPOSE) logs -f celery_worker

status: ## ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
	@echo "ğŸ“Š Service Status:"
	@$(DOCKER_COMPOSE) ps

health: ## í—¬ìŠ¤ì²´í¬
	@echo "ğŸ¥ Health Check..."
	@curl -s http://localhost:8000/ | jq '.'
	@echo ""
	@curl -s http://localhost:8000/health | jq '.'

test: ## ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (pytest)
	@echo "ğŸ§ª Running tests..."
	$(POETRY) run pytest tests/ -v --tb=short

test-api: ## API í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "ğŸ§ª Running API integration tests..."
	@chmod +x test_api.sh
	@./test_api.sh

test-unit: ## ìœ ë‹› í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "ğŸ§ª Running unit tests..."
	$(POETRY) run pytest tests/test_audio_loop.py -v

shell-api: ## FastAPI ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†
	$(DOCKER_COMPOSE) exec api /bin/bash

shell-celery: ## Celery Worker ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†
	$(DOCKER_COMPOSE) exec celery_worker /bin/bash

clean: ## ìƒì„±ëœ íŒŒì¼ ì •ë¦¬
	@echo "ğŸ§¹ Cleaning up..."
	rm -rf outputs/audio/*.mp3
	rm -f test_verified_audio.mp3
	rm -rf __pycache__ .pytest_cache
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ“ Cleaned!"

clean-all: clean down ## ëª¨ë“  ë°ì´í„° ì‚­ì œ (Docker ë³¼ë¥¨ í¬í•¨)
	@echo "âš ï¸  Removing Docker volumes..."
	$(DOCKER_COMPOSE) down -v
	@echo "âœ“ All data removed!"

build: ## Docker ì´ë¯¸ì§€ ë¹Œë“œ
	@echo "ğŸ”¨ Building Docker images..."
	$(DOCKER_COMPOSE) build

flower: ## Flower ëŒ€ì‹œë³´ë“œ ì—´ê¸°
	@echo "ğŸŒ¸ Opening Flower..."
	@open http://localhost:5555 || xdg-open http://localhost:5555 || echo "Open http://localhost:5555 in your browser"

docs: ## API ë¬¸ì„œ ì—´ê¸°
	@echo "ğŸ“– Opening API documentation..."
	@open http://localhost:8000/docs || xdg-open http://localhost:8000/docs || echo "Open http://localhost:8000/docs in your browser"

neo4j: ## Neo4j ë¸Œë¼ìš°ì € ì—´ê¸°
	@echo "ğŸ”— Opening Neo4j Browser..."
	@open http://localhost:7474 || xdg-open http://localhost:7474 || echo "Open http://localhost:7474 in your browser"

dev: ## ê°œë°œ ëª¨ë“œ ì‹œì‘ (ë¡œì»¬)
	@echo "ğŸ’» Starting development server..."
	$(POETRY) run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

celery-worker: ## Celery Worker ë¡œì»¬ ì‹¤í–‰
	@echo "ğŸ‘· Starting Celery worker..."
	$(POETRY) run celery -A app.tasks.celery_app worker --loglevel=info

celery-flower: ## Flower ë¡œì»¬ ì‹¤í–‰
	@echo "ğŸŒ¸ Starting Flower..."
	$(POETRY) run celery -A app.tasks.celery_app flower --port=5555

init: install up ## ì´ˆê¸° ì„¤ì • (ì˜ì¡´ì„± ì„¤ì¹˜ + ì„œë¹„ìŠ¤ ì‹œì‘)
	@echo "ğŸ‰ Initialization complete!"
	@echo ""
	@$(MAKE) docs

demo: up ## ë°ëª¨ ì‹¤í–‰ (ì„œë¹„ìŠ¤ ì‹œì‘ + API í…ŒìŠ¤íŠ¸)
	@echo "ğŸ¬ Starting demo..."
	@sleep 5
	@$(MAKE) test-api
